---
title: "3220Base"
output: html_document
date: "2025-07-09"
---

# 0a. Load Data and Directories

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(readxl)  
library(dplyr)   
library(ggplot2)   
library(janitor) 
library(scales)
library(tidyr)
library(reshape)
library(tibble)
library(broom)
library(fs)
library(e1071)
library(readr) 

file_path <- "D:/OneDrive - University of Virginia/Will M/Undergraduate Research Courses-Grants/Summer 2025/Introduction to Regression Analysis (STAT 3220)/Final Project/3220-Final-Project/Data/2025 County Health Rankings Virginia Data - v3.xlsx"

excel_sheets(file_path)

addl_df   <- read_excel(file_path, sheet = "Additional Measure Data") %>% clean_names()
measure_df <- read_excel(file_path, sheet = "Select Measure Data")    %>% clean_names()

data_dir <- dirname(file_path)   

write_csv(addl_df,
          file = file.path(data_dir, "additional_measure_data.csv"))
write_csv(measure_df,
          file = file.path(data_dir, "select_measure_data.csv"))

graphics_root <- "D:/OneDrive - University of Virginia/Will M/Undergraduate Research Courses-Grants/Summer 2025/Introduction to Regression Analysis (STAT 3220)/Final Project/3220-Final-Project/Graphics"

plot_folders <- c(
  Histogram   = "1_Histogram",
  Income      = "2_Income",
  Physician   = "3_Physician",
  Obesity     = "4_Obesity",
  Exercise    = "5_Exercise",
  Rural       = "6_Rural",
  Correlation = "7_Correlation"
)

plot_dirs <- setNames(file.path(graphics_root, plot_folders),
                      names(plot_folders))  

dir.create(graphics_root, showWarnings = FALSE)
invisible(lapply(plot_dirs, dir.create, showWarnings = FALSE))

dir_histogram   <- plot_dirs[["Histogram"]] 
dir_income      <- plot_dirs[["Income"]]
dir_physician   <- plot_dirs[["Physician"]]
dir_obesity     <- plot_dirs[["Obesity"]]
dir_exercise    <- plot_dirs[["Exercise"]]
dir_rural       <- plot_dirs[["Rural"]]
dir_correlation <- plot_dirs[["Correlation"]]

print(plot_dirs)
```


# 0b. Combine the two sheets and engineer helper variables

```{r cars}
full_df <- addl_df %>% 
  inner_join(
      measure_df %>% 
        select(fips,
               percent_with_access_to_exercise_opportunities,
               everything()),
      by = "fips"
  ) %>% 
  mutate(
      exercise_tertile = ntile(percent_with_access_to_exercise_opportunities, 3) %>% 
                         factor(levels = 1:3, labels = c("Low","Mid","High"))
  ) %>% 
  
  mutate(
    primary_care_physicians_ratio =
      as.numeric(sub(":1$", "", primary_care_physicians_ratio))
  ) %>% 
  
  mutate(
    phys_ratio_band = cut(
      primary_care_physicians_ratio,
      breaks  = c(-Inf, 1000, 2000, 3000, 5000, Inf),
      labels  = c("<=1k", "1-2k", "2-3k", "3-5k", ">=5k"),   
      right   = TRUE,
      ordered_result = TRUE
    )
  ) %>% 
  mutate(
    rural_band = cut(
      percent_rural,
      breaks  = c(-Inf, 25, 50, 75, 100),
      labels  = c("0-25%", "26-50%", "51-75%", "76-100%"),
      right   = TRUE,
      ordered_result = TRUE
    )
  )

write_csv(full_df,
          file = file.path(data_dir, "combined_full_data.csv"))
```

# 1. Histogram of Life Expectancy Counts (Counties)

```{r pressure, echo=FALSE}

addl_df <- addl_df %>% 
  filter(!is.na(county), county != "NA")    

p_hist <- ggplot(addl_df, aes(x = life_expectancy)) +
  geom_histogram(binwidth = 1,
                 fill     = "steelblue",
                 colour   = "white") +
  labs(title = "Distribution of Life Expectancy Across Virginia Counties (2025)",
       x     = "Life Expectancy (years)",
       y     = "Number of Counties") +
  theme_minimal()
print(p_hist)

# Stats - Break

stats_hist <- addl_df %>% 
  summarise(
    n          = n(),
    min        = min(life_expectancy, na.rm = TRUE),
    q1         = quantile(life_expectancy, 0.25, na.rm = TRUE),
    median     = median(life_expectancy, na.rm = TRUE),
    mean       = mean(life_expectancy, na.rm = TRUE),
    q3         = quantile(life_expectancy, 0.75, na.rm = TRUE),
    max        = max(life_expectancy, na.rm = TRUE),
    sd         = sd(life_expectancy,  na.rm = TRUE),
    skewness   = e1071::skewness(life_expectancy, na.rm = TRUE),
    kurtosis   = e1071::kurtosis(life_expectancy, na.rm = TRUE)
  )

ggsave(
  filename = file.path(dir_histogram, "life_expectancy_histogram.png"),
  plot     = p_hist,
  width    = 7,
  height   = 5,
  dpi      = 300
)

file_out_stats <- file.path(dir_histogram, "life_expectancy_stats.csv")

readr::write_csv(stats_hist, file_out_stats)

print(stats_hist)
```

# 2. Scatterplot: Life Expectancy vs. Median Income (+ LOESS)

```{r pressure, echo=FALSE}
p_scatter <- ggplot(full_df,
                    aes(x = median_household_income,
                        y = life_expectancy)) +
  geom_point(colour = "steelblue", alpha = 0.8) +
  geom_smooth(method = "loess", se = FALSE, colour = "darkred") +
  scale_x_continuous(labels = dollar_format()) +
  labs(title = "Life Expectancy vs. Median Household Income",
       x = "Median Household Income (USD)",
       y = "Life Expectancy (years)") +
  theme_minimal()

p_scatter

ggsave(
  filename = file.path(dir_income, "income_vs_life_expectancy.png"),
  plot     = p_scatter,
  width    = 7,
  height   = 5,
  dpi      = 300
)

# Stats - Break 

stats_x <- full_df %>% 
  summarise(var     = "median_household_income",
            n       = n(),
            min     = min(median_household_income, na.rm = TRUE),
            q1      = quantile(median_household_income, 0.25, na.rm = TRUE),
            median  = median(median_household_income, na.rm = TRUE),
            mean    = mean(median_household_income, na.rm = TRUE),
            q3      = quantile(median_household_income, 0.75, na.rm = TRUE),
            max     = max(median_household_income, na.rm = TRUE),
            sd      = sd(median_household_income, na.rm = TRUE),
            skew    = skewness(median_household_income, na.rm = TRUE),
            kurt    = kurtosis(median_household_income, na.rm = TRUE))

stats_y <- full_df %>% 
  summarise(var     = "life_expectancy",
            n       = n(),
            min     = min(life_expectancy, na.rm = TRUE),
            q1      = quantile(life_expectancy, 0.25, na.rm = TRUE),
            median  = median(life_expectancy, na.rm = TRUE),
            mean    = mean(life_expectancy, na.rm = TRUE),
            q3      = quantile(life_expectancy, 0.75, na.rm = TRUE),
            max     = max(life_expectancy, na.rm = TRUE),
            sd      = sd(life_expectancy, na.rm = TRUE),
            skew    = skewness(life_expectancy, na.rm = TRUE),
            kurt    = kurtosis(life_expectancy, na.rm = TRUE))

descriptive_stats <- bind_rows(stats_x, stats_y)

descriptive_stats

cor_xy     <- cor(full_df$median_household_income,
                  full_df$life_expectancy,
                  use = "complete.obs")
cor_xy

loess_fit  <- loess(life_expectancy ~ median_household_income, data = full_df)
loess_sum  <- summary(loess_fit)
loess_sum

model_stats <- tibble(
  metric = c("pearson_correlation",
             "loess_equiv_params",  
             "loess_resid_se",      
             "loess_trace_hat"),     
  value  = c(cor_xy,
             loess_sum$enp,
             loess_sum$s,
             loess_sum$trace.hat)
)
model_stats

write_csv(descriptive_stats,
          file.path(dir_income, "income_vs_life_expectancy_descstats.csv"))

write_csv(model_stats,
          file.path(dir_income, "income_vs_life_expectancy_modelstats.csv"))
```

# 3. Scatterplot: Life Expectancy vs. Primary-Care Physician Ratio

```{r pressure, echo=FALSE}
plot_df <- full_df %>% 
           filter(!is.na(phys_ratio_band))

p_phys <- ggplot(plot_df,
                 aes(x   = phys_ratio_band,
                     y   = life_expectancy,
                     fill = phys_ratio_band)) +
  geom_boxplot(alpha = 0.7, outlier.alpha = 0.4) +
  scale_x_discrete(limits = rev(levels(plot_df$phys_ratio_band))) + 
  scale_fill_brewer(palette = "YlGnBu",
                    name     = "Physician-ratio band") +
  labs(title = "Life Expectancy by Physician-Ratio Band",
       x = "Population per Primary-Care Physician\n(higher = fewer physicians)",
       y = "Life Expectancy (years)") +
  theme_minimal()

# Stats - Break

stats_phys <- plot_df %>%                        
  group_by(phys_ratio_band) %>% 
  summarise(
    n                 = n(),
    min_phys_ratio    = min(primary_care_physicians_ratio, na.rm = TRUE),
    q1_phys_ratio     = quantile(primary_care_physicians_ratio, 0.25, na.rm = TRUE),
    median_phys       = median(primary_care_physicians_ratio, na.rm = TRUE),
    mean_phys         = mean(primary_care_physicians_ratio, na.rm = TRUE),
    q3_phys_ratio     = quantile(primary_care_physicians_ratio, 0.75, na.rm = TRUE),
    max_phys_ratio    = max(primary_care_physicians_ratio, na.rm = TRUE),
    min_life_exp      = min(life_expectancy, na.rm = TRUE),
    q1_life_exp       = quantile(life_expectancy, 0.25, na.rm = TRUE),
    median_life_exp   = median(life_expectancy, na.rm = TRUE),
    mean_life_exp     = mean(life_expectancy, na.rm = TRUE),
    q3_life_exp       = quantile(life_expectancy, 0.75, na.rm = TRUE),
    max_life_exp      = max(life_expectancy, na.rm = TRUE),
    sd_phys_ratio     = sd(primary_care_physicians_ratio, na.rm = TRUE),
    sd_life_exp       = sd(life_expectancy,             na.rm = TRUE)
  ) %>% 
  ungroup()

plot_file  <- file.path(dir_physician, "life_expectancy_by_phys_band.png")
stats_file <- file.path(dir_physician, "life_expectancy_by_phys_band_stats.csv")

ggsave(plot_file, p_phys, width = 7, height = 5, dpi = 300)
readr::write_csv(stats_phys, stats_file)

cat("Plot saved to:  ", plot_file,  "\n")
cat("Stats saved to: ", stats_file, "\n")

print(p_phys)
print(stats_phys)
```

# 4. Scatterplot: Life Expectancy vs. Adult Obesity (%)

```{r pressure, echo=FALSE}

p_obesity <- ggplot(full_df,
                    aes(x = percent_adults_with_obesity,
                        y = life_expectancy)) +
  geom_point(colour = "tomato", alpha = 0.8) +
  geom_smooth(method = "loess", se = FALSE, colour = "black") +
  labs(title = "Life Expectancy vs. Adult Obesity",
       x = "Adult Obesity (%)",
       y = "Life Expectancy (years)") +
  theme_minimal()

# Stats - Break

stats_obesity <- full_df %>% 
  summarise(
 n                   = n(),
    min_obesity         = min(percent_adults_with_obesity, na.rm = TRUE),
    q1_obesity          = quantile(percent_adults_with_obesity, 0.25, na.rm = TRUE),
    median_obesity      = median(percent_adults_with_obesity, na.rm = TRUE),
    mean_obesity        = mean(percent_adults_with_obesity, na.rm = TRUE),
    q3_obesity          = quantile(percent_adults_with_obesity, 0.75, na.rm = TRUE),
    max_obesity         = max(percent_adults_with_obesity, na.rm = TRUE),
    
    min_life_exp        = min(life_expectancy, na.rm = TRUE),
    q1_life_exp         = quantile(life_expectancy, 0.25, na.rm = TRUE),
    median_life_exp     = median(life_expectancy, na.rm = TRUE),
    mean_life_exp       = mean(life_expectancy, na.rm = TRUE),
    q3_life_exp         = quantile(life_expectancy, 0.75, na.rm = TRUE),
    max_life_exp        = max(life_expectancy, na.rm = TRUE),
    
    sd_obesity          = sd(percent_adults_with_obesity, na.rm = TRUE),
    sd_life_exp         = sd(life_expectancy,             na.rm = TRUE),
    
    cor_pearson         = cor(percent_adults_with_obesity,
                              life_expectancy,
                              use = "pairwise.complete.obs",
                              method = "pearson"),
    
    lm_slope            = coef(lm(life_expectancy ~ percent_adults_with_obesity))[2],
    lm_intercept        = coef(lm(life_expectancy ~ percent_adults_with_obesity))[1],
    lm_r_squared        = summary(lm(life_expectancy ~ percent_adults_with_obesity))$r.squared
  )

plot_file_ob <- file.path(dir_obesity, "life_expectancy_vs_obesity.png")
stats_file_ob <- file.path(dir_obesity, "life_expectancy_vs_obesity_stats.csv")

ggsave(plot_file_ob, p_obesity, width = 7, height = 5, dpi = 300)
readr::write_csv(stats_obesity, stats_file_ob)

cat("Plot saved to:  ", plot_file_ob,  "\n")
cat("Stats saved to: ", stats_file_ob, "\n")
print(p_obesity)
print(stats_obesity)
```

# 5. Faceted scatter: Life Expectancy ~ Adult Obesity, coloured by Exercise-Access Tertile

```{r pressure, echo=FALSE}

p_exercise <- full_df %>% 
  filter(!is.na(exercise_tertile)) %>%         
  ggplot(aes(x = percent_adults_with_obesity,
             y = life_expectancy,
             colour = exercise_tertile)) +
  geom_point(size = 2, alpha = 0.8) +
  scale_colour_brewer(palette = "Dark2",
                      name = "Exercise Access",
                      na.translate = FALSE) +      
  facet_wrap(~ exercise_tertile, nrow = 1, drop = TRUE) +
  labs(title = "Life Expectancy vs. Obesity by Exercise-Access Tertile",
       x = "Adult Obesity (%)",
       y = "Life Expectancy (years)") +
  theme_minimal()

print(p_exercise)

# Stats - Break

stats_exercise <- full_df %>% 
  filter(!is.na(exercise_tertile)) %>%                    

  filter(!is.na(percent_adults_with_obesity),
         !is.na(life_expectancy)) %>%                     

  group_by(exercise_tertile) %>% 
  summarise(
    n                  = n(),

    min_obesity        = min(percent_adults_with_obesity),
    q1_obesity         = quantile(percent_adults_with_obesity, .25),
    median_obesity     = median(percent_adults_with_obesity),
    mean_obesity       = mean(percent_adults_with_obesity),
    q3_obesity         = quantile(percent_adults_with_obesity, .75),
    max_obesity        = max(percent_adults_with_obesity),
    sd_obesity         = sd(percent_adults_with_obesity),

    min_life_exp       = min(life_expectancy),
    q1_life_exp        = quantile(life_expectancy, .25),
    median_life_exp    = median(life_expectancy),
    mean_life_exp      = mean(life_expectancy),
    q3_life_exp        = quantile(life_expectancy, .75),
    max_life_exp       = max(life_expectancy),
    sd_life_exp        = sd(life_expectancy),

    cor_pearson        = cor(percent_adults_with_obesity, life_expectancy),

    lm_slope           = coef(lm(life_expectancy ~ percent_adults_with_obesity))[2],
    lm_intercept       = coef(lm(life_expectancy ~ percent_adults_with_obesity))[1],
    lm_r_squared       = summary(lm(life_expectancy ~ percent_adults_with_obesity))$r.squared,

    .groups            = "drop"
  )

plot_file_ex  <- file.path(dir_exercise, "life_expectancy_vs_obesity_by_exercise.png")
stats_file_ex <- file.path(dir_exercise, "life_expectancy_vs_obesity_by_exercise_stats.csv")

ggsave(plot_file_ex, p_exercise, width = 9, height = 4, dpi = 300)
readr::write_csv(stats_exercise, stats_file_ex)

cat("Plot saved to:  ", plot_file_ex,  "\n")
cat("Stats saved to: ", stats_file_ex, "\n")
print(stats_exercise)
```

# 6. Boxplot: Life Expectancy by Rural

```{r pressure, echo=FALSE}
rural_cols <- c(
  "0-25%"   = "#1f78b4",
  "26-50%"  = "#33a02c",
  "51-75%"  = "#a6d854",
  "76-100%" = "#66c2a5"
)

df_rural <- full_df %>% filter(!is.na(rural_band))

p_rural <- ggplot(df_rural,
                  aes(x = rural_band,
                      y = life_expectancy,
                      fill = rural_band)) +
  geom_boxplot(alpha = 0.7, colour = "grey30") +
  scale_fill_manual(values = rural_cols, name = "Percent Rural") +
  labs(title = "Life Expectancy by Rural Status",
       x = "",
       y = "Life Expectancy (years)") +
  theme_minimal()


# Stats - Break

band_stats <- df_rural %>%                      
  group_by(rural_band) %>%                      
  summarise(
    n      = n(),
    min    = min(life_expectancy),
    Q1     = quantile(life_expectancy, .25),
    median = median(life_expectancy),
    mean   = mean(life_expectancy),
    Q3     = quantile(life_expectancy, .75),
    max    = max(life_expectancy),
    sd     = sd(life_expectancy),
    .groups = "drop"
  )

plot_file_rural  <- file.path(dir_rural,
                              "life_expectancy_by_rural_status.png")
stats_file_rural <- file.path(dir_rural,
                              "life_expectancy_by_rural_status_stats.csv")

ggsave(plot_file_rural, p_rural, width = 7, height = 4, dpi = 300)
readr::write_csv(band_stats, stats_file_rural)

cat("Plot saved to:  ", plot_file_rural,  "\n")
cat("Stats saved to: ", stats_file_rural, "\n")

print(p_rural)
print(band_stats)
```

# 7. Correlation Heat-map of Key Quantitative Predictors

```{r pressure, echo=FALSE}

num_vars <- full_df %>% 
  select(life_expectancy,
         median_household_income,
         percent_adults_with_obesity,
         primary_care_physicians_ratio,
         age_adjusted_death_rate,
         income_ratio,
         percent_with_access_to_exercise_opportunities) %>% 
  drop_na()

corr_mat  <- round(cor(num_vars), 2)

corr_long <- corr_mat %>% 
  as.data.frame() %>% 
  rownames_to_column("Var1") %>%        
  pivot_longer(-Var1, names_to = "Var2", values_to = "Pearson_r") %>% 
  arrange(Var1, Var2)

p_corr <- ggplot(corr_long, aes(Var1, Var2, fill = Pearson_r)) +  
  geom_tile(colour = "white") +
  geom_text(aes(label = sprintf("%.2f", Pearson_r)), size = 3) +
  scale_fill_gradient2(low = "firebrick", mid = "white", high = "steelblue",
                       midpoint = 0, limits = c(-1, 1), name = "Pearson r") +
  labs(title = "Correlation Heat-map of Key Quantitative Predictors",
       x = NULL, y = NULL) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

plot_file_corr  <- file.path(dir_correlation,
                             "correlation_heatmap_predictors.png")
stats_file_corr <- file.path(dir_correlation,
                             "correlation_matrix_predictors.csv")

ggsave(plot_file_corr, p_corr, width = 6.5, height = 6.5, dpi = 300)
readr::write_csv(corr_long, stats_file_corr)

cat("Plot saved to:  ", plot_file_corr,  "\n")
cat("Stats saved to: ", stats_file_corr, "\n")

print(p_corr)
print(head(corr_long, 10))
```

